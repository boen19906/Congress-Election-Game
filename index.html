<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congressional Election Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .setup-screen {
            padding: 40px;
            text-align: center;
        }

        .setup-screen h2 {
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .input-group {
            margin-bottom: 30px;
        }

        .input-group input {
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            max-width: 100%;
        }

        .party-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .party-card {
            background: #f8f9fa;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .party-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .party-card.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .party-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* District Selection Styles */
        .district-selection {
            margin: 30px 0;
        }

        .district-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .district-card {
            background: #f8f9fa;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .district-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .district-card.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .district-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .district-card.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .difficulty-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .difficulty-easy {
            background: #27ae60;
        }

        .difficulty-medium {
            background: #f39c12;
        }

        .difficulty-hard {
            background: #e74c3c;
        }

        .district-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .district-stats {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .platform-selection {
            margin: 30px 0;
        }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .platform-item {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .platform-item:hover {
            background: #e3f2fd;
        }

        .platform-item.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .start-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .week-indicator {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            padding: 20px;
            background: #3498db;
            color: white;
        }

        .candidate-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin: 0 auto 15px;
            border: 3px solid #ddd;
        }

        .candidate-avatar.democrat {
            background: #2196f3;
            color: white;
        }

        .candidate-avatar.republican {
            background: #f44336;
            color: white;
        }

        .candidate-avatar.independent {
            background: #9c27b0;
            color: white;
        }

        .stat-bar {
            margin: 15px 0;
        }

        .stat-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s ease;
        }

        .actions-remaining {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9em;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .action-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .next-week-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .opponent-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .opponent-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .opponent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            border: 2px solid #ddd;
        }

        .results-screen {
            padding: 40px;
            text-align: center;
        }

        .results-podium {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .podium-place {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            min-width: 150px;
            border: 3px solid #ddd;
        }

        .podium-place.first {
            border-color: #f1c40f;
            background: #fef9e7;
        }

        .podium-place.second {
            border-color: #95a5a6;
            background: #f8f9fa;
        }

        .podium-place.third {
            border-color: #e67e22;
            background: #fdf2e9;
        }

        .event-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .event-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .event-title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .event-options {
            margin-top: 30px;
        }

        .event-option {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .event-option:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .hidden {
            display: none !important;
        }

        .district-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .district-map {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* Debate Styles */
        .debate-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 95%;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .debate-header {
            margin-bottom: 20px;
        }

        .actions-remaining-debate {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 8px;
            margin: 10px 0;
            font-weight: bold;
            display: inline-block;
        }

        .debate-stage {
            background: linear-gradient(135deg, #8B4513, #D2691E);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .debate-candidates {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            min-height: 200px;
        }

        .debate-candidate {
            position: relative;
        }

        .candidate-podium {
            background: #8B4513;
            border-radius: 10px 10px 0 0;
            padding: 15px 10px;
            border: 3px solid #654321;
            min-width: 120px;
            position: relative;
        }

        .candidate-avatar-debate {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            margin: 0 auto 10px;
            border: 3px solid #333;
        }

        .candidate-avatar-debate.democrat {
            background: #2196f3;
            color: white;
        }

        .candidate-avatar-debate.republican {
            background: #f44336;
            color: white;
        }

        .candidate-avatar-debate.independent {
            background: #9c27b0;
            color: white;
        }

        .candidate-name-debate {
            font-weight: bold;
            font-size: 0.9em;
            color: white;
        }

        .speech-bubble {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #333;
            border-radius: 20px;
            padding: 10px 15px;
            margin-bottom: 10px;
            max-width: 200px;
            font-size: 0.85em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-top-color: white;
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 12px solid transparent;
            border-top-color: #333;
            z-index: -1;
        }

        .debate-question {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }

        .debate-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .debate-action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .promote-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .attack-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .clickbait-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .debate-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .debate-action-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .attack-selection {
            background: #ffe6e6;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .attack-targets {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .attack-target-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attack-target-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .finish-debate-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }

        .finish-debate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .party-selection {
                flex-direction: column;
                align-items: center;
            }
            
            .platform-grid {
                grid-template-columns: 1fr;
            }

            .district-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Congressional Election Simulator</h1>
            <p>Run for Congress and win your district!</p>
        </div>

        <!-- Setup Screen -->
        <div id="setup-screen" class="setup-screen">
            <h2>Create Your Candidate</h2>
            
            <div class="input-group">
                <input type="text" id="candidate-name" placeholder="Enter your candidate name" maxlength="30">
            </div>

            <h3>Choose Your Political Party</h3>
            <div class="party-selection">
                <div class="party-card" data-party="democrat" onclick="selectParty('democrat')">
                    <div class="party-icon democrat">üê¥</div>
                    <h4>Democrat</h4>
                    <p>Progressive values</p>
                </div>
                <div class="party-card" data-party="republican" onclick="selectParty('republican')">
                    <div class="party-icon republican">üêò</div>
                    <h4>Republican</h4>
                    <p>Conservative values</p>
                </div>
                <div class="party-card" data-party="independent" onclick="selectParty('independent')">
                    <div class="party-icon independent">‚≠ê</div>
                    <h4>Independent</h4>
                    <p>Your own path</p>
                </div>
            </div>

            <!-- District Selection -->
            <div class="district-selection">
                <h3>Choose Your District</h3>
                <p style="margin-bottom: 20px; color: #666;">Select the district you want to run in. Difficulty is based on how favorable the district is to your party.</p>
                <div class="district-grid" id="district-grid">
                    <!-- District cards will be populated by JavaScript -->
                </div>
            </div>

            <div class="platform-selection">
                <h3>Choose Your Platform Focus (Select 3)</h3>
                <div class="platform-grid">
                    <div class="platform-item" data-platform="economy" onclick="selectPlatform('economy')">
                        <strong>üíº Economy</strong>
                        <p>Jobs and economic growth</p>
                    </div>
                    <div class="platform-item" data-platform="healthcare" onclick="selectPlatform('healthcare')">
                        <strong>üè• Healthcare</strong>
                        <p>Medical care access</p>
                    </div>
                    <div class="platform-item" data-platform="education" onclick="selectPlatform('education')">
                        <strong>üìö Education</strong>
                        <p>Schools and learning</p>
                    </div>
                    <div class="platform-item" data-platform="environment" onclick="selectPlatform('environment')">
                        <strong>üå± Environment</strong>
                        <p>Climate and conservation</p>
                    </div>
                    <div class="platform-item" data-platform="security" onclick="selectPlatform('security')">
                        <strong>üõ°Ô∏è Security</strong>
                        <p>Safety and defense</p>
                    </div>
                    <div class="platform-item" data-platform="immigration" onclick="selectPlatform('immigration')">
                        <strong>üåç Immigration</strong>
                        <p>Border and citizenship</p>
                    </div>
                </div>
            </div>

            <button class="start-btn" onclick="startGame()">Start Campaign!</button>
        </div>

        <!-- Main Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="week-indicator">
                Week <span id="current-week">1</span> of 16
            </div>

            <div class="game-area">
                <!-- Player Panel -->
                <div class="panel candidate-panel">
                    <div id="player-avatar" class="candidate-avatar">üë§</div>
                    <div id="player-name" class="candidate-name">Your Name</div>
                    <div id="player-party" class="candidate-party">Your Party</div>
                    
                    <div class="actions-remaining">
                        Actions Left: <span id="actions-left">3</span>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">Poll Support: <span id="popularity-text">15%</span></div>
                        <div class="progress-bar">
                            <div id="popularity-bar" class="progress-fill" style="width: 15%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">Money: $<span id="money-text">25,000</span></div>
                        <div class="progress-bar">
                            <div id="money-bar" class="progress-fill" style="width: 25%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">Staff: <span id="staff-text">1</span></div>
                        <div class="progress-bar">
                            <div id="staff-bar" class="progress-fill" style="width: 10%"></div>
                        </div>
                    </div>

                    <div class="stat-bar">
                        <div class="stat-label">Name Recognition: <span id="recognition-text">5%</span></div>
                        <div class="progress-bar">
                            <div id="recognition-bar" class="progress-fill" style="width: 5%"></div>
                        </div>
                    </div>
                </div>

                <!-- Main Stage -->
                <div class="panel main-stage">
                    <div class="stage-content">
                        <div class="district-info">
                            <div class="district-map">üó∫Ô∏è</div>
                            <h3 id="district-name">Your District</h3>
                            <p id="district-lean">Political Lean</p>
                            <p id="district-type">District Type</p>
                        </div>

                        <div class="action-grid">
                            <button class="action-btn" onclick="takeAction('doorknock')">
                                üö™ Door-to-Door<br><small>$500 ‚Ä¢ Build support</small>
                            </button>
                            <button class="action-btn" onclick="takeAction('campaign')">
                                üì¢ Campaign Rally<br><small>$3,000 ‚Ä¢ Major event</small>
                            </button>
                            <button class="action-btn" onclick="takeAction('fundraise')">
                                üí∞ Fundraise<br><small>Raise money</small>
                            </button>
                            <button class="action-btn" onclick="takeAction('staff')">
                                üë• Hire Staff<br><small>$8,000 ‚Ä¢ +efficiency</small>
                            </button>
                            <button class="action-btn" onclick="takeAction('ad')">
                                üì∫ TV Ad<br><small>$12,000 ‚Ä¢ Reach voters</small>
                            </button>
                            <button class="action-btn" onclick="takeAction('digital')">
                                üì± Digital Ads<br><small>$5,000 ‚Ä¢ Online reach</small>
                            </button>
                            <button class="action-btn" onclick="takeAction('volunteer')">
                                ü§ù Volunteer Drive<br><small>$1,000 ‚Ä¢ Ground game</small>
                            </button>
                        </div>

                        <button class="next-week-btn" onclick="nextWeek()">Next Week ‚û°Ô∏è</button>
                    </div>
                </div>

                <!-- Opponents Panel -->
                <div class="panel">
                    <h3>Poll Numbers</h3>
                    <div id="opponents-list" class="opponents-list">
                        <!-- Opponents will be populated here -->
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                        <strong>Undecided: <span id="undecided-percent">25%</span></strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="results-screen hidden">
            <h2>üó≥Ô∏è Election Results</h2>
            <div id="results-podium" class="results-podium">
                <!-- Results will be populated here -->
            </div>
            <button class="start-btn" onclick="resetGame()">Play Again</button>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="event-modal">
        <div class="event-content">
            <div id="event-title" class="event-title">Random Event</div>
            <div id="event-description"></div>
            <div id="event-options" class="event-options">
                <!-- Event options will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Congressional Election Simulator - Enhanced with District Selection

        // Game state
        let gameState = {
            player: {
                name: '',
                party: '',
                money: 3000,
                popularity: 15,
                staff: 1,
                recognition: 5,
                platforms: [],
                actionsLeft: 3,
                baseSupport: 0,
                swingSupport: 0
            },
            district: {},
            opponents: [],
            currentWeek: 1,
            totalWeeks: 16,
            selectedParty: null,
            selectedDistrict: null,
            selectedPlatforms: [],
            debateActionsLeft: 3,
            debateResults: []
        };

        // Game data with realistic district breakdowns
        const districts = [
            { 
                name: 'Springfield District', 
                lean: 'Swing', 
                type: 'Mixed', 
                competitiveness: 0.9,
                demBase: 35, repBase: 36, swing: 12, undecided: 17,
                icon: '‚öñÔ∏è',
                description: 'A true swing district where every vote counts'
            },
            { 
                name: 'Madison Valley', 
                lean: 'Lean Blue', 
                type: 'Suburban', 
                competitiveness: 0.7,
                demBase: 40, repBase: 32, swing: 13, undecided: 15,
                icon: 'üèòÔ∏è',
                description: 'Suburban district with slight Democratic lean'
            },
            { 
                name: 'Franklin County', 
                lean: 'Lean Red', 
                type: 'Rural', 
                competitiveness: 0.7,
                demBase: 31, repBase: 41, swing: 13, undecided: 15,
                icon: 'üåæ',
                description: 'Rural district with slight Republican lean'
            },
            { 
                name: 'Riverside District', 
                lean: 'Deep Blue', 
                type: 'Urban', 
                competitiveness: 0.3,
                demBase: 52, repBase: 26, swing: 8, undecided: 14,
                icon: 'üèôÔ∏è',
                description: 'Safe Democratic urban stronghold'
            },
            { 
                name: 'Hill Country', 
                lean: 'Deep Red', 
                type: 'Rural', 
                competitiveness: 0.3,
                demBase: 25, repBase: 53, swing: 8, undecided: 14,
                icon: '‚õ∞Ô∏è',
                description: 'Safe Republican rural stronghold'
            },
            { 
                name: 'Tech Valley', 
                lean: 'Toss-up', 
                type: 'Suburban', 
                competitiveness: 0.95,
                demBase: 33, repBase: 33, swing: 16, undecided: 18,
                icon: 'üíª',
                description: 'Pure toss-up with tech industry influence'
            },
            { 
                name: 'Coal Country', 
                lean: 'Strong Red', 
                type: 'Rural', 
                competitiveness: 0.2,
                demBase: 22, repBase: 56, swing: 8, undecided: 14,
                icon: '‚õèÔ∏è',
                description: 'Very safe Republican mining district'
            }
        ];

        const platformEffects = {
            economy: { rural: 1.3, suburban: 1.0, urban: 0.8, mixed: 1.1 },
            healthcare: { rural: 0.7, suburban: 1.2, urban: 1.4, mixed: 1.1 },
            education: { rural: 0.6, suburban: 1.4, urban: 1.2, mixed: 1.1 },
            environment: { rural: 0.5, suburban: 1.1, urban: 1.5, mixed: 1.0 },
            security: { rural: 1.2, suburban: 1.0, urban: 0.7, mixed: 1.0 },
            immigration: { rural: 1.1, suburban: 0.9, urban: 1.0, mixed: 1.0 }
        };

        const events = [
            {
                title: 'Local Factory Closing',
                description: 'A major employer announces it will close, affecting thousands of jobs.',
                options: [
                    { text: 'Promise job retraining programs', effects: { swingSupport: 2, money: -3000, recognition: 1 } },
                    { text: 'Blame unfair trade policies', effects: { swingSupport: 1, money: 0, recognition: 1 } },
                    { text: 'Stay neutral on the issue', effects: { swingSupport: -2, money: 0, recognition: 0 } }
                ]
            },
            {
                title: 'Newspaper Endorsement Opportunity',
                description: 'The local newspaper wants to interview you for a potential endorsement.',
                options: [
                    { text: 'Accept and prepare thoroughly', effects: { swingSupport: 3, money: -1000, recognition: 4 } },
                    { text: 'Accept with minimal prep', effects: { swingSupport: 1, money: 0, recognition: 2 } },
                    { text: 'Decline citing bias concerns', effects: { swingSupport: -1, money: 0, recognition: 1 } }
                ]
            },
            {
                title: 'Scandal Allegation',
                description: 'Opponents spread rumors about your campaign finances.',
                options: [
                    { text: 'Full transparency with documents', effects: { swingSupport: 0, money: -2000, recognition: 2 } },
                    { text: 'Deny and counter-attack', effects: { swingSupport: -3, money: 0, recognition: 1 } },
                    { text: 'Hire crisis management team', effects: { swingSupport: -1, money: -8000, recognition: 1 } }
                ]
            },
            {
                title: 'Celebrity Endorsement',
                description: 'A local celebrity wants to endorse your campaign.',
                options: [
                    { text: 'Accept enthusiastically', effects: { swingSupport: 4, money: 0, recognition: 5 } },
                    { text: 'Accept quietly', effects: { swingSupport: 2, money: 0, recognition: 3 } },
                    { text: 'Politely decline', effects: { swingSupport: 0, money: 0, recognition: 1 } }
                ]
            },
            {
                title: 'Town Hall Meeting',
                description: 'Citizens organize a town hall on local issues.',
                options: [
                    { text: 'Attend and engage actively', effects: { swingSupport: 3, money: -500, recognition: 2 } },
                    { text: 'Attend but stay cautious', effects: { swingSupport: 1, money: 0, recognition: 1 } },
                    { text: 'Skip due to other commitments', effects: { swingSupport: -3, money: 0, recognition: 0 } }
                ]
            }
        ];

        const debateQuestions = [
            "How will you address the economy in our district?",
            "What's your stance on healthcare accessibility?",
            "How will you improve education in our community?", 
            "What are your plans for infrastructure development?",
            "How will you address climate and environmental concerns?"
        ];

        const platformResponses = {
            economy: [
                "I'll fight for good-paying jobs and support local businesses!",
                "We need to invest in job training and economic development.",
                "Small businesses are the backbone of our economy - I'll support them!"
            ],
            healthcare: [
                "Healthcare is a right, and I'll work to make it affordable for everyone.",
                "We need to expand access to quality healthcare in our district.",
                "I'll fight to lower prescription drug costs for our families."
            ],
            education: [
                "Every child deserves a quality education - I'll fully fund our schools.",
                "We need to invest in teachers and modernize our classrooms.",
                "Education is the key to our district's future prosperity."
            ],
            environment: [
                "We must take bold action on climate change for our children's future.",
                "Clean energy will create jobs while protecting our environment.",
                "Environmental protection and economic growth can go hand in hand."
            ],
            security: [
                "I'll always put the safety and security of our community first.",
                "We need smart investments in public safety and emergency preparedness.",
                "Keeping our families safe is my top priority."
            ],
            immigration: [
                "We need comprehensive immigration reform that's fair and humane.",
                "Immigration has always been part of America's strength.",
                "We must secure our borders while treating everyone with dignity."
            ]
        };

        const attackLines = [
            "My opponent's record shows they've consistently failed our district!",
            "While I've been fighting for working families, they've been absent!",
            "Their policies would hurt the very people they claim to represent!",
            "They talk a big game, but where were they when we needed leadership?",
            "My opponent is out of touch with the real needs of our community!"
        ];

        const clickbaitLines = [
            "The establishment doesn't want you to hear this, but...",
            "What I'm about to say will shock you about our district!",
            "The mainstream media won't report this, but I will!",
            "They don't want me to tell you the truth about...",
            "This is what they're hiding from hardworking families!"
        ];

        const opponentNames = [
            'Sarah Johnson', 'Mike Davis', 'Lisa Chen', 'Robert Wilson',
            'Maria Rodriguez', 'David Kim', 'Jennifer Brown', 'Chris Taylor',
            'Amanda Foster', 'James Mitchell', 'Rachel Green', 'Thomas Anderson'
        ];

        // Setup functions
        function selectParty(party) {
            document.querySelectorAll('.party-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-party="${party}"]`).classList.add('selected');
            gameState.selectedParty = party;
            updateDistrictDifficulties();
        }

        function updateDistrictDifficulties() {
            if (!gameState.selectedParty) return;
            
            const districtGrid = document.getElementById('district-grid');
            districtGrid.innerHTML = '';
            
            districts.forEach((district, index) => {
                const card = document.createElement('div');
                card.className = 'district-card';
                card.setAttribute('data-district', index);
                card.onclick = () => selectDistrict(index);
                
                // Calculate difficulty based on party
                let difficulty = 'medium';
                let difficultyText = 'Medium';
                
                if (gameState.selectedParty === 'democrat') {
                    if (district.demBase >= 50) {
                        difficulty = 'easy';
                        difficultyText = 'Easy';
                    } else if (district.demBase >= 35) {
                        difficulty = 'medium';
                        difficultyText = 'Medium';
                    } else {
                        difficulty = 'hard';
                        difficultyText = 'Hard';
                    }
                } else if (gameState.selectedParty === 'republican') {
                    if (district.repBase >= 50) {
                        difficulty = 'easy';
                        difficultyText = 'Easy';
                    } else if (district.repBase >= 35) {
                        difficulty = 'medium';
                        difficultyText = 'Medium';
                    } else {
                        difficulty = 'hard';
                        difficultyText = 'Hard';
                    }
                } else { // independent
                    // All districts are hard for independents, but some slightly easier
                    if (district.swing >= 14) {
                        difficulty = 'medium';
                        difficultyText = 'Medium';
                    } else {
                        difficulty = 'hard';
                        difficultyText = 'Hard';
                    }
                }
                
                card.innerHTML = `
                    <div class="difficulty-badge difficulty-${difficulty}">${difficultyText}</div>
                    <div class="district-icon">${district.icon}</div>
                    <h4>${district.name}</h4>
                    <p><strong>${district.lean}</strong> ‚Ä¢ ${district.type}</p>
                    <p>${district.description}</p>
                    <div class="district-stats">
                        Dem: ${district.demBase}% | Rep: ${district.repBase}% | Swing: ${district.swing}%
                    </div>
                `;
                
                districtGrid.appendChild(card);
            });
        }

        function selectDistrict(districtIndex) {
            if (!gameState.selectedParty) {
                alert('Please select a party first!');
                return;
            }
            
            document.querySelectorAll('.district-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-district="${districtIndex}"]`).classList.add('selected');
            gameState.selectedDistrict = districtIndex;
        }

        function selectPlatform(platform) {
            const element = document.querySelector(`[data-platform="${platform}"]`);
            
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                gameState.selectedPlatforms = gameState.selectedPlatforms.filter(p => p !== platform);
            } else if (gameState.selectedPlatforms.length < 3) {
                element.classList.add('selected');
                gameState.selectedPlatforms.push(platform);
            } else {
                alert('You can only select 3 platform issues!');
            }
        }

        function startGame() {
            const name = document.getElementById('candidate-name').value.trim();
            if (!name || !gameState.selectedParty || gameState.selectedDistrict === null || gameState.selectedPlatforms.length !== 3) {
                alert('Please enter your name, select a party, choose a district, and select exactly 3 platform issues!');
                return;
            }

            // Initialize player
            gameState.player.name = name;
            gameState.player.party = gameState.selectedParty;
            gameState.player.platforms = [...gameState.selectedPlatforms];

            // Set selected district
            gameState.district = districts[gameState.selectedDistrict];

            // Set undecided voters (starts high, decreases over time)
            gameState.undecidedVoters = gameState.district.undecided;

            // Set base support based on district and party
            setBaseSupport();

            // Generate strong opponents
            generateStrongOpponents();

            // Switch to game screen
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');

            updateUI();
        }

        function setBaseSupport() {
            const district = gameState.district;
            const party = gameState.player.party;
            
            if (party === 'democrat') {
                gameState.player.baseSupport = district.demBase;
            } else if (party === 'republican') {
                gameState.player.baseSupport = district.repBase;
            } else {
                gameState.player.baseSupport = 2; // Independents get almost nothing guaranteed
            }
            
            // Start with small portion of swing voters (1-3%)
            gameState.player.swingSupport = Math.floor(Math.random() * 3) + 1;
            
            // Calculate total popularity for display (base + swing)
            gameState.player.popularity = gameState.player.baseSupport + gameState.player.swingSupport;
        }

        function generateStrongOpponents() {
            const availableParties = ['democrat', 'republican'].filter(p => p !== gameState.selectedParty);
            gameState.opponents = [];
            
            // Create one major party opponent
            const majorParty = availableParties[0];
            const majorOpponent = {
                name: opponentNames[Math.floor(Math.random() * opponentNames.length)],
                party: majorParty,
                money: Math.floor(Math.random() * 60000) + 40000, // 40k-100k
                staff: Math.floor(Math.random() * 8) + 5, // 5-12 staff
                recognition: Math.floor(Math.random() * 30) + 40, // 40-70% recognition
                baseSupport: majorParty === 'democrat' ? gameState.district.demBase : gameState.district.repBase,
                swingSupport: Math.floor(Math.random() * 4) + 2 // 2-5% swing support
            };
            majorOpponent.popularity = majorOpponent.baseSupport + majorOpponent.swingSupport;
            gameState.opponents.push(majorOpponent);
            
            // Create weak independent if needed
            if (availableParties.length > 0) {
                const weakOpponent = {
                    name: opponentNames[Math.floor(Math.random() * opponentNames.length)],
                    party: 'independent',
                    money: Math.floor(Math.random() * 8000) + 2000, // 2k-10k
                    staff: 1,
                    recognition: Math.floor(Math.random() * 15) + 5, // 5-20% recognition
                    baseSupport: 1, // Almost no base
                    swingSupport: Math.floor(Math.random() * 2) + 1 // 1-2% swing support
                };
                weakOpponent.popularity = weakOpponent.baseSupport + weakOpponent.swingSupport;
                gameState.opponents.push(weakOpponent);
            }
        }

        function updateUI() {
            // Update player info
            document.getElementById('player-name').textContent = gameState.player.name;
            document.getElementById('player-party').textContent = gameState.player.party.charAt(0).toUpperCase() + gameState.player.party.slice(1);
            document.getElementById('player-avatar').className = `candidate-avatar ${gameState.player.party}`;

            // Update actions left
            document.getElementById('actions-left').textContent = gameState.player.actionsLeft;

            // Update stats - show realistic polling numbers
            const displayPopularity = Math.round(gameState.player.popularity * 10) / 10; // Show decimals
            document.getElementById('popularity-text').textContent = displayPopularity + '%';
            document.getElementById('popularity-bar').style.width = Math.min(100, gameState.player.popularity) + '%';
            
            document.getElementById('money-text').textContent = gameState.player.money.toLocaleString();
            document.getElementById('money-bar').style.width = Math.min(100, gameState.player.money / 1000) + '%';
            
            document.getElementById('staff-text').textContent = gameState.player.staff;
            document.getElementById('staff-bar').style.width = Math.min(100, gameState.player.staff * 10) + '%';

            document.getElementById('recognition-text').textContent = Math.round(gameState.player.recognition) + '%';
            document.getElementById('recognition-bar').style.width = Math.min(100, gameState.player.recognition) + '%';

            // Update district info
            document.getElementById('district-name').textContent = gameState.district.name;
            document.getElementById('district-lean').textContent = gameState.district.lean;
            document.getElementById('district-type').textContent = gameState.district.type;

            // Update week
            document.getElementById('current-week').textContent = gameState.currentWeek;

            // Update action buttons
            updateActionButtons();

            // Update opponents
            updateOpponents();
        }

        function updateActionButtons() {
            const buttons = document.querySelectorAll('.action-btn');
            buttons.forEach(button => {
                button.disabled = gameState.player.actionsLeft <= 0;
            });
        }

        function updateOpponents() {
            const opponentsList = document.getElementById('opponents-list');
            opponentsList.innerHTML = '';

            // FIXED: Calculate current undecided - starts high and decreases more gradually
            let currentUndecided = gameState.undecidedVoters;
            
            // Undecided voters start making decisions around week 10, accelerating after week 14
            if (gameState.currentWeek >= 10) {
                const weekProgress = (gameState.currentWeek - 10) / (gameState.totalWeeks - 10);
                const decisionRate = weekProgress < 0.7 ? weekProgress * 0.2 : 0.14 + (weekProgress - 0.7) * 2.5; // Very slow then fast
                currentUndecided = gameState.undecidedVoters * (1 - decisionRate);
            }
            
            // Small randomness but not too much
            currentUndecided += (Math.random() - 0.5) * 1;
            currentUndecided = Math.max(5, currentUndecided); // Keep at least 5% undecided until late in campaign

            // FIXED: Proper vote balancing to ensure total = 100%
            const allCandidates = [gameState.player, ...gameState.opponents];
            
            // Calculate base support total (this should be constant)
            const totalBase = gameState.district.demBase + gameState.district.repBase + 
                              (allCandidates.filter(c => c.party === 'independent').length * 1);
            
            // Calculate current swing support being claimed by all candidates
            const totalSwingClaimed = allCandidates.reduce((sum, candidate) => sum + candidate.swingSupport, 0);
            
            // Available votes = 100 - base support - undecided
            const availableForSwing = 100 - totalBase - currentUndecided;
            
            // If candidates are claiming more swing than available, proportionally reduce
            if (totalSwingClaimed > availableForSwing) {
                const reductionFactor = availableForSwing / totalSwingClaimed;
                allCandidates.forEach(candidate => {
                    candidate.swingSupport *= reductionFactor;
                    candidate.popularity = candidate.baseSupport + candidate.swingSupport;
                });
            }
            
            // Recalculate undecided to ensure total = 100%
            const finalTotalCommitted = allCandidates.reduce((sum, candidate) => sum + candidate.popularity, 0);
            currentUndecided = Math.max(0, 100 - finalTotalCommitted);

            // Add player to the list
            const playerCard = document.createElement('div');
            playerCard.className = 'opponent-card';
            const displayPop = Math.round(gameState.player.popularity * 10) / 10;
            playerCard.innerHTML = `
                <div class="opponent-info">
                    <div class="opponent-avatar ${gameState.player.party}">üë§</div>
                    <div>
                        <div style="font-weight: bold;">${gameState.player.name}</div>
                        <div style="font-size: 0.8em; opacity: 0.8;">${gameState.player.party.charAt(0).toUpperCase() + gameState.player.party.slice(1)}</div>
                        <div style="font-size: 0.7em; color: #666;">Base: ${gameState.player.baseSupport}% | Swing: ${Math.round(gameState.player.swingSupport * 10) / 10}%</div>
                    </div>
                </div>
                <div style="font-weight: bold; color: #27ae60;">${displayPop}%</div>
            `;
            opponentsList.appendChild(playerCard);

            // Add opponents
            gameState.opponents.forEach(opponent => {
                const card = document.createElement('div');
                card.className = 'opponent-card';
                const oppDisplayPop = Math.round(opponent.popularity * 10) / 10;
                card.innerHTML = `
                    <div class="opponent-info">
                        <div class="opponent-avatar ${opponent.party}">
                            ${opponent.party === 'democrat' ? 'üê¥' : opponent.party === 'republican' ? 'üêò' : '‚≠ê'}
                        </div>
                        <div>
                            <div style="font-weight: bold;">${opponent.name}</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">${opponent.party.charAt(0).toUpperCase() + opponent.party.slice(1)}</div>
                            <div style="font-size: 0.7em; color: #666;">Base: ${opponent.baseSupport}% | Swing: ${Math.round(opponent.swingSupport * 10) / 10}%</div>
                        </div>
                    </div>
                    <div style="font-weight: bold;">${oppDisplayPop}%</div>
                `;
                opponentsList.appendChild(card);
            });

            // Update undecided percentage - show current undecided
            document.getElementById('undecided-percent').textContent = Math.round(currentUndecided * 10) / 10 + '%';
            
            // Store current undecided for other functions
            gameState.currentUndecided = currentUndecided;
        }

        function takeAction(actionType) {
            if (gameState.player.actionsLeft <= 0) {
                alert('No actions left this week!');
                return;
            }

            let success = false;
            let message = '';
            let effects = {};

            switch (actionType) {
                case 'doorknock':
                    if (gameState.player.money >= 500) {
                        gameState.player.money -= 500;
                        const randomFactor = 0.8 + Math.random() * 0.4; // 0.8x to 1.2x
                        const swingGain = (Math.random() * 1.5 + 0.8) * randomFactor; // 0.8-3.0 swing
                        const recGain = Math.floor((Math.random() * 3 + 2) * randomFactor); // 2-5 recognition
                        effects = { swingSupport: swingGain, recognition: recGain };
                        message = `Door-to-door campaigning successful! Made personal connections with voters.`;
                        success = true;
                    } else {
                        message = 'Not enough money for door-to-door campaign!';
                    }
                    break;

                case 'campaign':
                    if (gameState.player.money >= 3000) {
                        gameState.player.money -= 3000;
                        const randomFactor = 0.8 + Math.random() * 0.4; // 0.8x to 1.2x
                        const swingGain = (Math.random() * 2.5 + 1.0) * randomFactor; // 1.0-4.0 swing
                        const recGain = Math.floor((Math.random() * 5 + 3) * randomFactor); // 3-8 recognition
                        effects = { swingSupport: swingGain, recognition: recGain };
                        message = `Campaign rally successful! Energized base and reached swing voters.`;
                        success = true;
                    } else {
                        message = 'Not enough money for campaign rally!';
                    }
                    break;

                case 'fundraise':
                    const staffMultiplier = 1 + (gameState.player.staff * 0.15);
                    const popularityMultiplier = 0.6 + (gameState.player.popularity / 100 * 0.8);
                    const recognitionMultiplier = 0.7 + (gameState.player.recognition / 100 * 0.6);
                    const randomMultiplier = 0.6 + Math.random() * 0.8;
                    
                    const baseAmount = Math.floor(Math.random() * 8000) + 3000; // Increased base
                    const raised = Math.floor(baseAmount * staffMultiplier * popularityMultiplier * recognitionMultiplier * randomMultiplier);
                    
                    gameState.player.money += raised;
                    effects = { recognition: Math.floor(Math.random() * 3) + 2 }; // 2-4 recognition
                    message = `Fundraising successful! Raised ${raised.toLocaleString()}.`;
                    success = true;
                    break;

                case 'staff':
                    if (gameState.player.money >= 8000) {
                        gameState.player.money -= 8000;
                        gameState.player.staff += 1;
                        const randomFactor = 0.9 + Math.random() * 0.2; // 0.9x to 1.1x
                        effects = { 
                            swingSupport: (Math.random() * 1.0 + 0.5) * randomFactor, // 0.5-1.5 swing
                            recognition: Math.floor((Math.random() * 3 + 2) * randomFactor) // 2-5 recognition
                        };
                        message = 'New staff hired! Campaign efficiency improved.';
                        success = true;
                    } else {
                        message = 'Not enough money to hire staff!';
                    }
                    break;

                case 'ad':
                    if (gameState.player.money >= 12000) {
                        gameState.player.money -= 12000;
                        const randomFactor = 0.9 + Math.random() * 0.2; // 0.9x to 1.1x
                        const swingGain = (Math.random() * 3.5 + 2.0) * randomFactor; // 2.0-5.5 swing
                        const recGain = Math.floor((Math.random() * 8 + 5) * randomFactor); // 5-13 recognition
                        effects = { swingSupport: swingGain, recognition: recGain };
                        message = `TV ad campaign successful! Wide audience reached.`;
                        success = true;
                    } else {
                        message = 'Not enough money for TV ads!';
                    }
                    break;

                case 'digital':
                    if (gameState.player.money >= 5000) {
                        gameState.player.money -= 5000;
                        const randomFactor = 0.8 + Math.random() * 0.4; // 0.8x to 1.2x
                        const swingGain = (Math.random() * 2.5 + 1.0) * randomFactor; // 1.0-4.0 swing
                        const recGain = Math.floor((Math.random() * 6 + 3) * randomFactor); // 3-9 recognition
                        effects = { swingSupport: swingGain, recognition: recGain };
                        message = `Digital advertising successful! Online engagement boosted.`;
                        success = true;
                    } else {
                        message = 'Not enough money for digital ads!';
                    }
                    break;

                case 'volunteer':
                    if (gameState.player.money >= 1000) {
                        gameState.player.money -= 1000;
                        const randomFactor = 0.8 + Math.random() * 0.4; // 0.8x to 1.2x
                        const swingGain = (Math.random() * 1.8 + 0.7) * randomFactor; // 0.7-3.0 swing
                        const recGain = Math.floor((Math.random() * 4 + 2) * randomFactor); // 2-6 recognition
                        effects = { swingSupport: swingGain, recognition: recGain };
                        message = `Volunteer drive successful! Ground game strengthened.`;
                        success = true;
                    } else {
                        message = 'Not enough money for volunteer coordination!';
                    }
                    break;
            }

            if (success) {
                applyEffects(effects);
                gameState.player.actionsLeft--;
                
                setTimeout(() => alert(message), 100);
                updateUI();
            } else {
                alert(message);
            }
        }

        // FIXED: Better swing voter management with proper constraints
        function applyEffects(effects) {
            // Apply platform bonuses based on district type
            const districtType = gameState.district.type.toLowerCase();
            let platformBonus = 1.0;

            gameState.player.platforms.forEach(platform => {
                if (platformEffects[platform] && platformEffects[platform][districtType]) {
                    platformBonus += (platformEffects[platform][districtType] - 1) * 0.3;
                }
            });

            // FIXED: Logarithmic difficulty with proper constraints
            if (effects.swingSupport) {
                const currentSwing = gameState.player.swingSupport;
                
                // Calculate total available swing + undecided (this is the theoretical max)
                const totalAvailableVoters = gameState.district.swing + gameState.district.undecided;
                
                // Logarithmic difficulty scaling
                let difficultyMultiplier = 1.0;
                if (currentSwing > totalAvailableVoters * 0.2) { // Start scaling after 20% of available
                    const progressRatio = currentSwing / totalAvailableVoters;
                    // Smoother logarithmic curve - gets harder but never impossible
                    difficultyMultiplier = Math.max(0.15, 1 - (Math.log(1 + 3 * progressRatio) / Math.log(4)) * 0.85);
                }
                
                const scaledGain = effects.swingSupport * platformBonus * difficultyMultiplier;
                gameState.player.swingSupport += scaledGain;
                
                // SOFT CAP: Can exceed district swing but with exponentially increasing difficulty
                // This allows for exceptional performances while maintaining realism
                const softCap = totalAvailableVoters * 0.85; // Can realistically get 85% of swing+undecided
                if (gameState.player.swingSupport > softCap) {
                    const excess = gameState.player.swingSupport - softCap;
                    const dampening = Math.exp(-excess * 0.3); // Exponential dampening
                    gameState.player.swingSupport = softCap + excess * dampening;
                }
            }
            
            if (effects.recognition) {
                const recognitionMultiplier = Math.max(0.4, 1 - (gameState.player.recognition / 120));
                gameState.player.recognition += effects.recognition * recognitionMultiplier;
            }
            
            if (effects.money) {
                gameState.player.money += effects.money;
            }

            // Update total popularity
            gameState.player.popularity = gameState.player.baseSupport + gameState.player.swingSupport;

            // Cap values appropriately
            gameState.player.recognition = Math.max(0, Math.min(100, gameState.player.recognition));
            gameState.player.money = Math.max(0, gameState.player.money);
        }

        function nextWeek() {
            if (gameState.currentWeek === 10) {
                showDebate();
                return;
            }

            gameState.player.actionsLeft = 3;
            processOpponentActions();
            
            if (Math.random() < 0.35) {
                showRandomEvent();
                return;
            }
            
            gameState.currentWeek++;
            
            // Weekly decay
            if (gameState.currentWeek > 4) {
                gameState.player.swingSupport = Math.max(0, gameState.player.swingSupport - 0.1);
                gameState.player.recognition -= 0.5;
                gameState.player.popularity = gameState.player.baseSupport + gameState.player.swingSupport;
            }
            
            if (gameState.currentWeek > gameState.totalWeeks) {
                showResults();
            } else {
                updateUI();
            }
        }

        // FIXED: Opponent actions with proper vote balancing
        function processOpponentActions() {
            gameState.opponents.forEach(opponent => {
                const isMajorParty = opponent.party !== 'independent';
                const actionsCount = isMajorParty ? 
                    Math.floor(Math.random() * 3) + 3 : // 3-5 actions for major parties
                    Math.floor(Math.random() * 2) + 1;   // 1-2 actions for independents
                
                const effectiveness = isMajorParty ? 1.3 : 0.4;
                
                for (let i = 0; i < actionsCount; i++) {
                    const actions = ['doorToDoor', 'rally', 'tvAds', 'digitalAds', 'volunteers', 'hireStaff', 'fundraise'];
                    const actionType = actions[Math.floor(Math.random() * actions.length)];
                    
                    // FIXED: Same constraints as player
                    const currentSwing = opponent.swingSupport;
                    const totalAvailableVoters = gameState.district.swing + gameState.district.undecided;
                    
                    let difficultyMultiplier = 1.0;
                    if (currentSwing > totalAvailableVoters * 0.2) {
                        const progressRatio = currentSwing / totalAvailableVoters;
                        difficultyMultiplier = Math.max(0.15, 1 - (Math.log(1 + 3 * progressRatio) / Math.log(4)) * 0.85);
                    }
                    
                    let actionTaken = false;
                    
                    if (actionType === 'doorToDoor' && opponent.money >= 500) {
                        opponent.money -= 500;
                        const swingGain = (Math.random() * 1.0 + 0.3) * effectiveness * difficultyMultiplier;
                        const recGain = Math.floor((Math.random() * 3 + 1) * effectiveness);
                        opponent.swingSupport += swingGain;
                        opponent.recognition += recGain;
                        actionTaken = true;
                    }
                    else if (actionType === 'rally' && opponent.money >= 3000) {
                        opponent.money -= 3000;
                        const swingGain = (Math.random() * 1.8 + 0.7) * effectiveness * difficultyMultiplier;
                        const recGain = Math.floor((Math.random() * 5 + 2) * effectiveness);
                        opponent.swingSupport += swingGain;
                        opponent.recognition += recGain;
                        actionTaken = true;
                    }
                    else if (actionType === 'tvAds' && opponent.money >= 12000) {
                        opponent.money -= 12000;
                        const swingGain = (Math.random() * 2.5 + 1.2) * effectiveness * difficultyMultiplier;
                        const recGain = Math.floor((Math.random() * 8 + 5) * effectiveness);
                        opponent.swingSupport += swingGain;
                        opponent.recognition += recGain;
                        actionTaken = true;
                    }
                    else if (actionType === 'digitalAds' && opponent.money >= 5000) {
                        opponent.money -= 5000;
                        const swingGain = (Math.random() * 1.5 + 0.5) * effectiveness * difficultyMultiplier;
                        const recGain = Math.floor((Math.random() * 6 + 3) * effectiveness);
                        opponent.swingSupport += swingGain;
                        opponent.recognition += recGain;
                        actionTaken = true;
                    }
                    else if (actionType === 'volunteers' && opponent.money >= 1000) {
                        opponent.money -= 1000;
                        const swingGain = (Math.random() * 1.0 + 0.4) * effectiveness * difficultyMultiplier;
                        const recGain = Math.floor((Math.random() * 4 + 2) * effectiveness);
                        opponent.swingSupport += swingGain;
                        opponent.recognition += recGain;
                        actionTaken = true;
                    }
                    else if (actionType === 'hireStaff' && opponent.money >= 8000) {
                        opponent.money -= 8000;
                        opponent.staff += 1;
                        const swingGain = (Math.random() * 0.8 + 0.3) * effectiveness;
                        const recGain = Math.floor((Math.random() * 3 + 2) * effectiveness);
                        opponent.swingSupport += swingGain;
                        opponent.recognition += recGain;
                        actionTaken = true;
                    }
                    else if (actionType === 'fundraise') {
                        const staffMultiplier = 1 + (opponent.staff * (isMajorParty ? 0.25 : 0.15));
                        const popularityMultiplier = 0.8 + (opponent.popularity / 60);
                        const recognitionMultiplier = 0.9 + (opponent.recognition / 80 * 0.6);
                        const randomMultiplier = 0.8 + Math.random() * 0.7;
                        
                        const baseAmount = isMajorParty ? 
                            Math.floor(Math.random() * 20000) + 10000 : // 10k-30k
                            Math.floor(Math.random() * 3000) + 1000;    // 1k-4k for independents
                        
                        const raised = Math.floor(baseAmount * staffMultiplier * popularityMultiplier * recognitionMultiplier * randomMultiplier * effectiveness);
                        
                        opponent.money += raised;
                        opponent.recognition += Math.floor((Math.random() * 4 + 2) * effectiveness);
                        actionTaken = true;
                    }
                    
                    // FIXED: Apply soft cap to opponents too
                    const softCap = totalAvailableVoters * 0.85;
                    if (opponent.swingSupport > softCap) {
                        const excess = opponent.swingSupport - softCap;
                        const dampening = Math.exp(-excess * 0.3);
                        opponent.swingSupport = softCap + excess * dampening;
                    }
                }
                
                // Update opponent total popularity
                opponent.popularity = opponent.baseSupport + opponent.swingSupport;
                
                if (isMajorParty) {
                    // Weekly funding boost
                    opponent.money += Math.floor(Math.random() * 5000) + 2000; // 2k-7k
                    opponent.recognition += Math.floor(Math.random() * 2) + 1; // 1-3 recognition
                    
                    // Big donor events
                    if (Math.random() < 0.2) { // 20% chance per week
                        opponent.money += Math.floor(Math.random() * 30000) + 15000; // 15k-45k
                    }
                    
                    // FIXED: Late game momentum with constraints
                    if (gameState.currentWeek > 12) {
                        const currentSwing = opponent.swingSupport;
                        const totalAvailableVoters = gameState.district.swing + gameState.district.undecided;
                        
                        let momentumMultiplier = 1.0;
                        if (currentSwing > totalAvailableVoters * 0.2) {
                            const progressRatio = currentSwing / totalAvailableVoters;
                            momentumMultiplier = Math.max(0.15, 1 - (Math.log(1 + 3 * progressRatio) / Math.log(4)) * 0.85);
                        }
                        
                        const momentumGain = (Math.random() * 0.5 + 0.1) * momentumMultiplier;
                        opponent.swingSupport += momentumGain;
                        
                        // Apply soft cap
                        const softCap = totalAvailableVoters * 0.85;
                        if (opponent.swingSupport > softCap) {
                            const excess = opponent.swingSupport - softCap;
                            const dampening = Math.exp(-excess * 0.3);
                            opponent.swingSupport = softCap + excess * dampening;
                        }
                    }
                } else {
                    // Independents get minimal help
                    opponent.money += Math.floor(Math.random() * 1000) + 200; // 200-1200 weekly
                    
                    if (Math.random() < 0.08) { // 8% chance per week
                        opponent.money += Math.floor(Math.random() * 2000) + 500; // 500-2500 donation
                    }
                }
                
                // Cap recognition
                const maxRec = isMajorParty ? 90 : 40;
                opponent.recognition = Math.max(0, Math.min(maxRec, opponent.recognition));
                
                // Weekly decay
                if (gameState.currentWeek > 6) {
                    const decayRate = isMajorParty ? 0.05 : 0.15;
                    opponent.swingSupport = Math.max(0, opponent.swingSupport - decayRate);
                    opponent.recognition -= decayRate * 0.8;
                }
                
                // Update final popularity
                opponent.popularity = opponent.baseSupport + opponent.swingSupport;
            });
        }

        function showRandomEvent() {
            const event = events[Math.floor(Math.random() * events.length)];
            
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-description').textContent = event.description;
            
            const optionsContainer = document.getElementById('event-options');
            optionsContainer.innerHTML = '';
            
            event.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'event-option';
                optionDiv.textContent = option.text;
                optionDiv.onclick = () => selectEventOption(option.effects);
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('event-modal').style.display = 'flex';
        }

        function selectEventOption(effects) {
            applyEffects(effects);
            
            document.getElementById('event-modal').style.display = 'none';
            updateUI();
            
            gameState.currentWeek++;
            
            if (gameState.currentWeek > gameState.totalWeeks) {
                showResults();
            } else {
                updateUI();
            }
        }

        function showDebate() {
            if (!document.getElementById('debate-modal')) {
                createDebateModal();
            }

            gameState.debateActionsLeft = 3;
            gameState.debateResults = [];
            gameState.currentQuestionIndex = 0;
            gameState.askedQuestions = [];
            
            const availableQuestions = [...debateQuestions];
            for (let i = 0; i < 3; i++) {
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                gameState.askedQuestions.push(availableQuestions.splice(randomIndex, 1)[0]);
            }

            // Setup debate UI
            const playerDebateName = document.getElementById('player-debate-name');
            const playerDebateAvatar = document.getElementById('player-debate-avatar');
            const opp1DebateName = document.getElementById('opp1-debate-name');
            const opp1DebateAvatar = document.getElementById('opp1-debate-avatar');
            const opp2DebateName = document.getElementById('opp2-debate-name');
            const opp2DebateAvatar = document.getElementById('opp2-debate-avatar');
            const attackName1 = document.getElementById('attack-name1');
            const attackName2 = document.getElementById('attack-name2');
            const debateQuestionText = document.getElementById('debate-question-text');
            const debateActionsLeft = document.getElementById('debate-actions-left');
            const attackSelection = document.getElementById('attack-selection');
            const finishDebate = document.getElementById('finish-debate');
            const debateModal = document.getElementById('debate-modal');

            if (playerDebateName) playerDebateName.textContent = gameState.player.name;
            if (playerDebateAvatar) playerDebateAvatar.className = `candidate-avatar-debate ${gameState.player.party}`;
            
            if (opp1DebateName) opp1DebateName.textContent = gameState.opponents[0].name;
            if (opp1DebateAvatar) opp1DebateAvatar.className = `candidate-avatar-debate ${gameState.opponents[0].party}`;
            if (attackName1) attackName1.textContent = gameState.opponents[0].name;
            
            if (gameState.opponents[1]) {
                if (opp2DebateName) opp2DebateName.textContent = gameState.opponents[1].name;
                if (opp2DebateAvatar) opp2DebateAvatar.className = `candidate-avatar-debate ${gameState.opponents[1].party}`;
                if (attackName2) attackName2.textContent = gameState.opponents[1].name;
            }

            if (debateQuestionText) debateQuestionText.textContent = gameState.askedQuestions[0];
            if (debateActionsLeft) debateActionsLeft.textContent = gameState.debateActionsLeft;

            if (attackSelection) attackSelection.classList.add('hidden');
            if (finishDebate) finishDebate.classList.add('hidden');

            if (debateModal) debateModal.style.display = 'flex';
        }

        function createDebateModal() {
            const modalHTML = `
                <div id="debate-modal" class="event-modal">
                    <div class="debate-content">
                        <div class="debate-header">
                            <h2>üé§ Congressional Debate</h2>
                            <div class="actions-remaining-debate">
                                Questions Left: <span id="debate-actions-left">3</span>
                            </div>
                        </div>

                        <div class="debate-question">
                            <h3>üìã Question:</h3>
                            <p id="debate-question-text">How will you address the economy in our district?</p>
                        </div>

                        <div class="debate-stage">
                            <div class="debate-candidates">
                                <div class="debate-candidate">
                                    <div class="candidate-podium">
                                        <div id="player-debate-avatar" class="candidate-avatar-debate">üë§</div>
                                        <div id="player-debate-name" class="candidate-name-debate">You</div>
                                    </div>
                                    <div id="player-speech" class="speech-bubble hidden"></div>
                                </div>

                                <div class="debate-candidate">
                                    <div class="candidate-podium">
                                        <div id="opp1-debate-avatar" class="candidate-avatar-debate">üê¥</div>
                                        <div id="opp1-debate-name" class="candidate-name-debate">Opponent 1</div>
                                    </div>
                                    <div id="opp1-speech" class="speech-bubble hidden"></div>
                                </div>

                                <div class="debate-candidate">
                                    <div class="candidate-podium">
                                        <div id="opp2-debate-avatar" class="candidate-avatar-debate">üêò</div>
                                        <div id="opp2-debate-name" class="candidate-name-debate">Opponent 2</div>
                                    </div>
                                    <div id="opp2-speech" class="speech-bubble hidden"></div>
                                </div>
                            </div>
                        </div>

                        <div class="debate-actions">
                            <button class="debate-action-btn promote-btn" onclick="debateAction('promote')">
                                üì¢ Promote Platform<br><small>Safe choice, small gains</small>
                            </button>
                            <button class="debate-action-btn attack-btn" onclick="showAttackOptions()">
                                ‚öîÔ∏è Attack Opponent<br><small>Risky, moderate reward</small>
                            </button>
                            <button class="debate-action-btn clickbait-btn" onclick="debateAction('clickbait')">
                                üî• Sensationalist Appeal<br><small>Very risky, high reward</small>
                            </button>
                        </div>

                        <div id="attack-selection" class="attack-selection hidden">
                            <h4>Choose your target:</h4>
                            <div class="attack-targets">
                                <button class="attack-target-btn" onclick="debateAction('attack', 0)">
                                    Attack <span id="attack-name1">Opponent 1</span>
                                </button>
                                <button class="attack-target-btn" onclick="debateAction('attack', 1)">
                                    Attack <span id="attack-name2">Opponent 2</span>
                                </button>
                            </div>
                        </div>

                        <button id="finish-debate" class="finish-debate-btn hidden" onclick="finishDebate()">
                            Finish Debate
                        </button>

                        <div id="poll-change-display" class="poll-change-display hidden">
                            <h4>üìä Poll Changes:</h4>
                            <pre id="poll-changes-text"></pre>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function showAttackOptions() {
            document.getElementById('attack-selection').classList.remove('hidden');
        }

        function getQuestionTopic(question) {
            if (question.includes('economy') || question.includes('jobs') || question.includes('business')) {
                return 'economy';
            } else if (question.includes('healthcare') || question.includes('health')) {
                return 'healthcare';
            } else if (question.includes('education') || question.includes('school')) {
                return 'education';
            } else if (question.includes('environment') || question.includes('climate')) {
                return 'environment';
            } else if (question.includes('security') || question.includes('safety')) {
                return 'security';
            } else if (question.includes('immigration')) {
                return 'immigration';
            } else {
                return 'economy';
            }
        }

        function debateAction(actionType, targetIndex = null) {
            if (gameState.debateActionsLeft <= 0) {
                alert('No debate questions left!');
                return;
            }

            const currentQuestion = gameState.askedQuestions[gameState.currentQuestionIndex];
            const questionTopic = getQuestionTopic(currentQuestion);

            let playerMessage = '';
            let effects = { swingSupport: 0, recognition: 0 };
            let opponentResponses = ['', ''];

            const prevSwing = gameState.player.swingSupport;
            const prevRecognition = gameState.player.recognition;

            switch (actionType) {
                case 'promote':
                    const responses = platformResponses[questionTopic] || platformResponses.economy;
                    playerMessage = responses[Math.floor(Math.random() * responses.length)];
                    
                    effects.swingSupport = Math.random() * 0.8 + 0.2; // 0.2-1.0 swing gain
                    effects.recognition = Math.floor(Math.random() * 2) + 1; // 1-2 recognition
                    
                    const topicResponses = {
                        economy: ["That's an interesting economic approach, but I believe we need more targeted solutions.", "While I respect that economic view, my plan focuses on immediate job creation."],
                        healthcare: ["Healthcare is complex - we need more comprehensive solutions.", "I agree healthcare is important, but we need to consider cost implications."],
                        education: ["Education funding is crucial, but we also need accountability measures.", "I support education investment, but we must ensure efficient use of resources."],
                        environment: ["Environmental concerns are valid, but we must balance with economic needs.", "Climate action is important, but we need practical, achievable solutions."],
                        security: ["Security is paramount, but we need community-focused approaches.", "I agree on safety priorities, but prevention is equally important."],
                        immigration: ["Immigration policy requires nuanced, bipartisan solutions.", "We need comprehensive reform that addresses all stakeholder concerns."]
                    };
                    
                    opponentResponses = topicResponses[questionTopic] || topicResponses.economy;
                    break;

                case 'attack':
                    const target = gameState.opponents[targetIndex];
                    playerMessage = attackLines[Math.floor(Math.random() * attackLines.length)];
                    
                    const attackSuccess = Math.random() > 0.4; // 60% success rate
                    
                    if (attackSuccess) {
                        effects.swingSupport = Math.random() * 1.5 + 0.5; // 0.5-2.0 swing gain
                        effects.recognition = Math.floor(Math.random() * 3) + 2; // 2-4 recognition
                        
                        // Target loses swing support
                        target.swingSupport = Math.max(0, target.swingSupport - (Math.random() * 1.0 + 0.5));
                        target.popularity = target.baseSupport + target.swingSupport;
                        
                        opponentResponses[targetIndex] = "Those are baseless attacks from someone who's desperate!";
                        opponentResponses[1 - targetIndex] = "We should focus on the issues, not personal attacks.";
                    } else {
                        // Attack backfires
                        effects.swingSupport = -(Math.random() * 1.0 + 0.3); // 0.3-1.3 loss
                        effects.recognition = Math.floor(Math.random() * 2) + 1; // Still gain recognition
                        
                        opponentResponses[targetIndex] = "Those attacks only show you have no real solutions!";
                        opponentResponses[1 - targetIndex] = "Negative campaigning has no place in this debate.";
                    }
                    
                    document.getElementById('attack-selection').classList.add('hidden');
                    break;

                case 'clickbait':
                    playerMessage = clickbaitLines[Math.floor(Math.random() * clickbaitLines.length)];
                    
                    const clickbaitSuccess = Math.random() > 0.6; // 40% success rate
                    
                    if (clickbaitSuccess) {
                        effects.swingSupport = Math.random() * 3.0 + 1.0; // 1.0-4.0 big gain
                        effects.recognition = Math.floor(Math.random() * 5) + 3; // 3-7 recognition
                        
                        opponentResponses = [
                            "That's just sensationalism without substance!",
                            "We need real solutions, not conspiracy theories!"
                        ];
                    } else {
                        effects.swingSupport = -(Math.random() * 2.0 + 1.0); // 1.0-3.0 big loss
                        effects.recognition = Math.floor(Math.random() * 3) + 2; // Still gain recognition
                        
                        opponentResponses = [
                            "That kind of rhetoric is exactly what's wrong with politics today!",
                            "Let's stick to facts instead of fear-mongering."
                        ];
                    }
                    break;
            }

            applyEffects(effects);
            gameState.debateActionsLeft--;
            gameState.currentQuestionIndex++;

            showPollChanges(prevSwing, prevRecognition, effects);

            showSpeechBubble('player-speech', playerMessage);
            
            setTimeout(() => {
                if (opponentResponses[0]) {
                    showSpeechBubble('opp1-speech', opponentResponses[0]);
                }
                if (opponentResponses[1] && gameState.opponents[1]) {
                    showSpeechBubble('opp2-speech', opponentResponses[1]);
                }
            }, 1500);

            document.getElementById('debate-actions-left').textContent = gameState.debateActionsLeft;
            
            if (gameState.debateActionsLeft > 0 && gameState.currentQuestionIndex < gameState.askedQuestions.length) {
                setTimeout(() => {
                    const debateQuestionText = document.getElementById('debate-question-text');
                    if (debateQuestionText) {
                        debateQuestionText.textContent = gameState.askedQuestions[gameState.currentQuestionIndex];
                    }
                }, 4000);
            }

            if (gameState.debateActionsLeft <= 0) {
                setTimeout(() => {
                    document.getElementById('finish-debate').classList.remove('hidden');
                }, 4000);
            }

            gameState.debateResults.push({
                action: actionType,
                effects: effects,
                message: playerMessage,
                question: currentQuestion
            });
        }

        function showPollChanges(prevSwing, prevRecognition, effects) {
            const pollChangeDisplay = document.getElementById('poll-change-display');
            const pollChangesText = document.getElementById('poll-changes-text');
            
            if (pollChangeDisplay && pollChangesText) {
                let changeText = '';
                
                if (effects.swingSupport !== 0) {
                    const newSwing = gameState.player.swingSupport;
                    changeText += `Swing Support: ${prevSwing.toFixed(1)}% ‚Üí ${newSwing.toFixed(1)}% `;
                    changeText += `(${effects.swingSupport > 0 ? '+' : ''}${effects.swingSupport.toFixed(1)}%)\n`;
                }
                
                if (effects.recognition !== 0) {
                    changeText += `Recognition: ${prevRecognition}% ‚Üí ${gameState.player.recognition}% `;
                    changeText += `(${effects.recognition > 0 ? '+' : ''}${effects.recognition}%)`;
                }
                
                pollChangesText.textContent = changeText;
                pollChangeDisplay.classList.remove('hidden');
                
                setTimeout(() => {
                    pollChangeDisplay.classList.add('hidden');
                }, 5000);
            }
        }

        function showSpeechBubble(elementId, message) {
            const bubble = document.getElementById(elementId);
            if (!bubble) {
                console.warn(`Speech bubble element ${elementId} not found`);
                return;
            }
            
            bubble.textContent = message;
            bubble.classList.remove('hidden');
            
            setTimeout(() => {
                if (bubble) {
                    bubble.classList.add('hidden');
                }
            }, 3000);
        }

        function finishDebate() {
            const debateModal = document.getElementById('debate-modal');
            if (debateModal) {
                debateModal.style.display = 'none';
            }
            
            let totalSwingChange = 0;
            let totalRecognitionChange = 0;
            
            gameState.debateResults.forEach(result => {
                totalSwingChange += result.effects.swingSupport || 0;
                totalRecognitionChange += result.effects.recognition || 0;
            });
            
            let resultMessage = `üé§ Debate Results:\n\n`;
            resultMessage += `Questions Covered:\n`;
            gameState.debateResults.forEach((result, index) => {
                resultMessage += `${index + 1}. ${result.question}\n`;
            });
            resultMessage += `\nFinal Changes:\n`;
            resultMessage += `Swing voter support: ${totalSwingChange > 0 ? '+' : ''}${totalSwingChange.toFixed(1)}%\n`;
            resultMessage += `Recognition: ${gameState.player.recognition}%\n\n`;
            
            if (totalSwingChange > 2) {
                resultMessage += "Outstanding debate performance! You won over many swing voters! üåü";
            } else if (totalSwingChange > 0) {
                resultMessage += "Good debate performance! You made progress with swing voters. üëç";
            } else if (totalSwingChange < -1) {
                resultMessage += "Rough debate. You may have lost some swing voters. üò¨";
            } else {
                resultMessage += "Mixed results. The race remains tight. ü§∑‚Äç‚ôÇÔ∏è";
            }
            
            setTimeout(() => {
                alert(resultMessage);
                
                gameState.currentWeek++;
                gameState.player.actionsLeft = 3;
                
                if (gameState.currentWeek > gameState.totalWeeks) {
                    showResults();
                } else {
                    updateUI();
                }
            }, 500);
        }

        function showResults() {
            const candidates = [
                { 
                    name: gameState.player.name, 
                    party: gameState.player.party, 
                    support: gameState.player.popularity,
                    recognition: gameState.player.recognition,
                    isPlayer: true 
                },
                ...gameState.opponents.map(opp => ({ 
                    ...opp, 
                    support: opp.popularity,
                    isPlayer: false 
                }))
            ];
            
            // Final undecided voter allocation - they break towards candidates based on recognition and late trends
            const finalUndecided = gameState.currentUndecided || 1;
            
            // Distribute undecided voters based on recognition, momentum, and some randomness
            candidates.forEach(candidate => {
                const recognitionWeight = candidate.recognition / 100;
                const momentumWeight = candidate.party !== 'independent' ? 0.8 : 0.2; // Major parties get more undecided
                const randomWeight = Math.random() * 0.4 + 0.8; // 0.8-1.2x random factor
                
                const totalWeight = candidates.reduce((sum, c) => {
                    const cRecWeight = c.recognition / 100;
                    const cMomentumWeight = c.party !== 'independent' ? 0.8 : 0.2;
                    const cRandomWeight = Math.random() * 0.4 + 0.8;
                    return sum + (cRecWeight * cMomentumWeight * cRandomWeight);
                }, 0);
                
                const undecidedShare = (recognitionWeight * momentumWeight * randomWeight) / totalWeight;
                
                candidate.undecidedBonus = finalUndecided * undecidedShare;
                candidate.finalSupport = candidate.support + candidate.undecidedBonus;
            });
            
            // Realistic election dynamics - recognition affects turnout efficiency
            candidates.forEach(candidate => {
                const recognitionBonus = candidate.recognition / 100;
                const turnoutEfficiency = 0.75 + recognitionBonus * 0.25; // 75-100% turnout efficiency
                candidate.finalVote = candidate.finalSupport * turnoutEfficiency;
                
                // Minimal randomness (elections are mostly predictable)
                const randomness = candidate.party === 'independent' ? 2 : 3;
                candidate.finalVote += (Math.random() - 0.5) * randomness;
                candidate.finalVote = Math.max(0, candidate.finalVote);
            });
            
            // Normalize to 100%
            const totalVotes = candidates.reduce((sum, c) => sum + c.finalVote, 0);
            candidates.forEach(candidate => {
                candidate.finalVote = (candidate.finalVote / totalVotes) * 100;
            });
            
            candidates.sort((a, b) => b.finalVote - a.finalVote);
            
            const podium = document.getElementById('results-podium');
            podium.innerHTML = '';
            
            const places = ['first', 'second', 'third'];
            
            candidates.forEach((candidate, index) => {
                const place = document.createElement('div');
                place.className = `podium-place ${places[index] || 'third'}`;
                
                const emoji = candidate.isPlayer ? 'üë§' : 
                             candidate.party === 'democrat' ? 'üê¥' : 
                             candidate.party === 'republican' ? 'üêò' : '‚≠ê';
                
                place.innerHTML = `
                    <div style="font-size: 2em; margin-bottom: 10px;">${emoji}</div>
                    <div style="font-weight: bold; margin-bottom: 5px;">${candidate.name}</div>
                    <div style="font-size: 0.9em; margin-bottom: 5px;">${candidate.party.charAt(0).toUpperCase() + candidate.party.slice(1)}</div>
                    <div style="font-size: 0.8em; margin-bottom: 10px; color: #666;">
                        ${candidate.undecidedBonus ? `+${candidate.undecidedBonus.toFixed(1)}% from undecided` : ''}
                    </div>
                    <div style="font-size: 1.2em; font-weight: bold;">${candidate.finalVote.toFixed(1)}%</div>
                `;
                
                podium.appendChild(place);
            });
            
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            
            const playerResult = candidates.find(c => c.isPlayer);
            const playerPlace = candidates.indexOf(playerResult) + 1;
            const margin = Math.abs(candidates[0].finalVote - candidates[1].finalVote);
            
            setTimeout(() => {
                let message = '';
                if (playerPlace === 1) {
                    if (margin < 2) {
                        message = 'üéâ Congratulations! You won in a nail-biter! üéâ\n';
                    } else {
                        message = 'üéâ Congratulations! You won the election! üéâ\n';
                    }
                } else if (playerPlace === 2 && margin < 3) {
                    message = 'üòê So close! You lost by just ' + margin.toFixed(1) + ' percentage points.\n';
                } else {
                    message = 'üòû You lost the election. In this district, every swing voter counts!\n';
                }
                
                // Show undecided voter breakdown
                if (finalUndecided > 2) {
                    message += `\n${finalUndecided.toFixed(1)}% of voters were undecided until the end and broke:\n`;
                    candidates.forEach(candidate => {
                        if (candidate.undecidedBonus > 0.5) {
                            message += `‚Ä¢ ${candidate.name}: +${candidate.undecidedBonus.toFixed(1)}%\n`;
                        }
                    });
                }
                
                alert(message);
            }, 500);
        }

        function resetGame() {
            gameState = {
                player: {
                    name: '',
                    party: '',
                    money: 3000,
                    popularity: 15,
                    staff: 1,
                    recognition: 5,
                    platforms: [],
                    actionsLeft: 3,
                    baseSupport: 0,
                    swingSupport: 0
                },
                district: {},
                opponents: [],
                currentWeek: 1,
                totalWeeks: 16,
                selectedParty: null,
                selectedDistrict: null,
                selectedPlatforms: [],
                debateActionsLeft: 3,
                debateResults: [],
                undecidedVoters: 0
            };
            
            document.getElementById('candidate-name').value = '';
            document.querySelectorAll('.party-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.district-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.platform-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Clear district grid
            document.getElementById('district-grid').innerHTML = '';
            
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        }

        // Initialize district selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Districts will be populated when a party is selected
        });
    </script>
</body>
</html> 